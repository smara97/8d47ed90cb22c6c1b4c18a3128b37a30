# ============================================================================
# captioner service Service - Docker Compose Configuration
# ============================================================================
#
# PURPOSE:
#   Docker Compose configuration for the captioner-service service that
#   processes video frames using blip method for captioner-service analysis in the Video RAG processing pipeline.
#
# SERVICE ROLE:
#   Consumes frames from raw-frames, processes them using blip, and publishes results to caption-results
#
# INTEGRATION POINTS:
#   Input Topic:   raw-frames
#   Output Topic:  caption-results
#   Dependencies:  Kafka message broker
#   Monitoring:    Health endpoint on port 8003
#
# RESOURCE ALLOCATION:
#   - Optimized for blip processing with 5 batch size
#   - Optimized for blip processing workloads
#   - Suitable for horizontal scaling in production
#
# SECURITY CONFIGURATION:
#   - Runs with no-new-privileges security option
#   - Non-root user execution within container
#   - Network isolation via dedicated bridge network
#
# ============================================================================


services:
  captioner-service:
    # Build configuration using local Dockerfile
    build:
      context: .              # Build context is current directory
      dockerfile: Dockerfile   # Use multi-stage Dockerfile for optimization
    
    # Container identification and networking
    container_name: captioner-service  # Fixed name for service discovery
    hostname: captioner-service        # Internal hostname for network communication
    
    # Port mapping for external access to health/metrics endpoints
    ports:
      - "8003:8000"  # Maps host port 8003 to container port 8000
    
    # Environment variables for service configuration
    environment:
      # Kafka connection configuration
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092  # Kafka broker connection string
      
      # Topic configuration for message processing
      - KAFKA_INPUT_TOPIC=raw-frames   # Input topic for consuming frames
      - KAFKA_OUTPUT_TOPIC=caption-results # Output topic for publishing results
      
      # Consumer group for Kafka message consumption
      - KAFKA_CONSUMER_GROUP=captioner-service-group
      
      # Service identification and configuration
      - SERVICE_NAME=captioner-service       # Service identifier
      
      # Logging configuration for operational visibility
      - LOG_LEVEL=INFO  # Standard logging level for production
      
      # # captioner-service specific environment variables
    
    # Service dependencies - ensures Kafka is available before startup
    
    # Network configuration for service communication
    networks:
      - video-rag-network  # Connects to shared network for inter-service communication
    
    # Restart policy for high availability
    restart: unless-stopped  # Automatically restarts unless explicitly stopped
    
    # Security configuration for container hardening
    security_opt:
      - no-new-privileges:true  # Prevents privilege escalation within container
    
    # Resource allocation and limits for performance management
    deploy:
      resources:
        # Maximum resource limits to prevent resource exhaustion
        limits:
          memory: 2G    # Maximum memory allocation
          cpus: '1.0'       # Maximum CPU allocation
        
        # Guaranteed resource reservations for consistent performance
        reservations:
          memory: 1G  # Guaranteed memory allocation
          cpus: '0.5'     # Guaranteed CPU allocation


# Network configuration
networks:
  video-rag-network:
    driver: bridge
    name: video-rag-network
    external: true