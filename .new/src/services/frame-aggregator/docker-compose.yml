# ============================================================================
# frame aggregator Service - Docker Compose Configuration
# ============================================================================
#
# PURPOSE:
#   Docker Compose configuration for the frame-aggregator service that
#   processes video frames using vector-store method for frame-aggregator analysis in the Video RAG processing pipeline.
#
# SERVICE ROLE:
#   Consumes frames from caption-results, processes them using vector-store, and publishes results to aggregated-results
#
# INTEGRATION POINTS:
#   Input Topic:   caption-results
#   Output Topic:  aggregated-results
#   Dependencies:  Kafka message broker
#   Monitoring:    Health endpoint on port 8004
#
# RESOURCE ALLOCATION:
#   - Optimized for vector-store processing with 5 batch size
#   - Optimized for vector-store processing workloads
#   - Suitable for horizontal scaling in production
#
# SECURITY CONFIGURATION:
#   - Runs with no-new-privileges security option
#   - Non-root user execution within container
#   - Network isolation via dedicated bridge network
#
# ============================================================================

services:
  frame-aggregator:
    # Build configuration using local Dockerfile
    build:
      context: .              # Build context is current directory
      dockerfile: Dockerfile   # Use multi-stage Dockerfile for optimization
    
    # Container identification and networking
    container_name: frame-aggregator  # Fixed name for service discovery
    hostname: frame-aggregator        # Internal hostname for network communication
    
    # Port mapping for external access to health/metrics endpoints
    ports:
      - "8004:8000"  # Maps host port 8004 to container port 8000
    
    # Environment variables for service configuration
    environment:
      # Kafka connection configuration
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092  # Kafka broker connection string
      
      # Topic configuration for message processing
      - KAFKA_INPUT_TOPIC=caption-results   # Input topic for consuming frames
      - KAFKA_OUTPUT_TOPIC=aggregated-results # Output topic for publishing results
      
      # Consumer group for Kafka message consumption
      - KAFKA_CONSUMER_GROUP=frame-aggregator-group
      
      # Service identification and configuration
      - SERVICE_NAME=frame-aggregator       # Service identifier
      
      # Logging configuration for operational visibility
      - LOG_LEVEL=INFO  # Standard logging level for production
      
      # # frame-aggregator specific environment variables
    
    # Service dependencies - ensures Kafka is available before startup
    
    # Network configuration for service communication
    networks:
      - video-rag-network  # Connects to shared network for inter-service communication
    
    # Restart policy for high availability
    restart: unless-stopped  # Automatically restarts unless explicitly stopped
    
    # Security configuration for container hardening
    security_opt:
      - no-new-privileges:true  # Prevents privilege escalation within container
    
    # Resource allocation and limits for performance management
    deploy:
      resources:
        # Maximum resource limits to prevent resource exhaustion
        limits:
          memory: 2G    # Maximum memory allocation
          cpus: '1.0'       # Maximum CPU allocation
        
        # Guaranteed resource reservations for consistent performance
        reservations:
          memory: 1G  # Guaranteed memory allocation
          cpus: '0.5'     # Guaranteed CPU allocation


# Network configuration
networks:
  video-rag-network:
    driver: bridge
    name: video-rag-network
    external: true