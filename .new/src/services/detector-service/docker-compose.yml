# ============================================================================
# detector service Service - Docker Compose Configuration
# ============================================================================
#
# PURPOSE:
#   Docker Compose configuration for the detector-service service that
#   processes video frames using yolo method for detector-service analysis in the Video RAG processing pipeline.
#
# SERVICE ROLE:
#   Consumes frames from raw-frames, processes them using yolo, and publishes results to detection-results
#
# INTEGRATION POINTS:
#   Input Topic:   raw-frames
#   Output Topic:  detection-results
#   Dependencies:  Kafka message broker
#   Monitoring:    Health endpoint on port 8002
#
# RESOURCE ALLOCATION:
#   - Optimized for yolo processing with 5 batch size
#   - Optimized for yolo processing workloads
#   - Suitable for horizontal scaling in production
#
# SECURITY CONFIGURATION:
#   - Runs with no-new-privileges security option
#   - Non-root user execution within container
#   - Network isolation via dedicated bridge network
#
# ============================================================================


services:
  detector-service:
    # Build configuration using local Dockerfile
    build:
      context: .              # Build context is current directory
      dockerfile: Dockerfile   # Use multi-stage Dockerfile for optimization
    
    # Container identification and networking
    container_name: detector-service  # Fixed name for service discovery
    hostname: detector-service        # Internal hostname for network communication
    
    # Port mapping for external access to health/metrics endpoints
    ports:
      - "8002:8000"  # Maps host port 8002 to container port 8000
    
    # Environment variables for service configuration
    environment:
      # Kafka connection configuration
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092  # Kafka broker connection string
      
      # Topic configuration for message processing
      - KAFKA_INPUT_TOPIC=raw-frames   # Input topic for consuming frames
      - KAFKA_OUTPUT_TOPIC=detection-results # Output topic for publishing results
      
      # Consumer group for Kafka message consumption
      - KAFKA_CONSUMER_GROUP=detector-service-group
      
      # Service identification and configuration
      - SERVICE_NAME=detector-service       # Service identifier
      
      # Logging configuration for operational visibility
      - LOG_LEVEL=INFO  # Standard logging level for production
      
      # # detector-service specific environment variables
    
    # Service dependencies - ensures Kafka is available before startup
    
    # Network configuration for service communication
    networks:
      - video-rag-network  # Connects to shared network for inter-service communication
    
    # Restart policy for high availability
    restart: unless-stopped  # Automatically restarts unless explicitly stopped
    
    # Security configuration for container hardening
    security_opt:
      - no-new-privileges:true  # Prevents privilege escalation within container
    
    # Resource allocation and limits for performance management
    deploy:
      resources:
        # Maximum resource limits to prevent resource exhaustion
        limits:
          memory: 2G    # Maximum memory allocation
          cpus: '1.0'       # Maximum CPU allocation
        
        # Guaranteed resource reservations for consistent performance
        reservations:
          memory: 1G  # Guaranteed memory allocation
          cpus: '0.5'     # Guaranteed CPU allocation

# Network configuration
networks:
  video-rag-network:
    driver: bridge
    name: video-rag-network
    external: true
# Network configuration
networks:
  video-rag-network:
    driver: bridge
    name: video-rag-network
    external: true