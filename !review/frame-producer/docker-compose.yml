version: '3.8'

# ============================================================================
# Frame Producer Service - Video Input Pipeline Entry Point
# ============================================================================
#
# PURPOSE:
#   Serves as the entry point for the Video RAG pipeline by extracting frames
#   from video sources and publishing them to Kafka for parallel processing
#   by downstream vision services.
#
# ROLE IN VIDEO RAG PIPELINE:
#   Input:  Video files, RTSP streams, or camera feeds
#   Process: Frame extraction, encoding, and metadata enrichment
#   Output: raw-frames topic (base64 encoded frames with metadata)
#
# PROCESSING WORKFLOW:
#   1. Read video from configured source (file/stream/camera)
#   2. Extract frames at specified intervals or FPS
#   3. Resize and normalize frames for consistent processing
#   4. Encode frames as base64 for Kafka transport
#   5. Add metadata (timestamp, frame_id, camera_id, dimensions)
#   6. Publish to 'raw-frames' topic for vision services consumption
#
# INPUT SOURCE SUPPORT:
#   - Video files: MP4, AVI, MOV, MKV formats
#   - RTSP streams: IP cameras and streaming servers
#   - USB cameras: Local camera devices
#   - Image sequences: Directory of image files
#   - Batch processing: Multiple video files
#
# FRAME PROCESSING:
#   - Configurable frame rate (FPS) extraction
#   - Automatic resolution normalization (640x640 default)
#   - Quality optimization for downstream processing
#   - Duplicate frame detection and skipping
#   - Temporal sampling strategies
#
# OUTPUT MESSAGE FORMAT:
#   {
#     "frame_id": "uuid-v4",
#     "camera_id": "cam_001",
#     "timestamp": 1234567890.123,
#     "frame_number": 150,
#     "frame_data": "base64_encoded_jpeg",
#     "metadata": {
#       "width": 640,
#       "height": 640,
#       "fps": 30,
#       "source": "video_file.mp4"
#     }
#   }
#
# PERFORMANCE CHARACTERISTICS:
#   - CPU-based processing (no GPU required)
#   - ~100-200 frames/second processing capability
#   - Memory usage: ~500MB-1GB (depends on video resolution)
#   - Configurable batch sizes for Kafka publishing
#   - Backpressure handling for downstream bottlenecks
#
# KAFKA INTEGRATION:
#   - Publishes to 'raw-frames' topic
#   - Partitioning by camera_id for ordered processing
#   - Configurable batch publishing for efficiency
#   - Automatic retry on Kafka connection failures
#
# DEPENDENCIES:
#   - Kafka cluster (healthy)
#   - OpenCV for video processing
#   - Video source accessibility
#   - Sufficient disk space for video files
#
# MONITORING:
#   - Health endpoint: http://localhost:8006/health
#   - Frame processing rate and queue depth
#   - Video source connection status
#   - Kafka publishing metrics
#
# ============================================================================

services:
  frame-producer:
    # Build from local Dockerfile with OpenCV and video processing dependencies
    build:
      context: .  # Current service directory
      dockerfile: Dockerfile
    
    container_name: ${FRAME_PRODUCER_CONTAINER_NAME}
    hostname: frame-producer  # Fixed hostname for service discovery
    
    # Port mapping for health checks and control interface
    ports:
      # HTTP API for health checks and processing control
      - "${FRAME_PRODUCER_HOST_PORT}:${FRAME_PRODUCER_INTERNAL_PORT}"  # 8006:8000
    
    # Service configuration via environment variables
    environment:
      # Kafka connection configuration
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS}  # kafka:9092
      
      # Output topic for frame publishing
      - KAFKA_OUTPUT_TOPIC=${KAFKA_TOPIC_RAW_FRAMES}        # raw-frames
      
      # Service identification
      - SERVICE_NAME=${FRAME_PRODUCER_NAME}                  # frame-producer
      
      # Logging configuration
      - LOG_LEVEL=${LOG_LEVEL}                               # INFO/DEBUG
      
      # Video source configuration
      # Can be file path, RTSP URL, or camera device ID
      - VIDEO_SOURCE=${FRAME_PRODUCER_VIDEO_SOURCE}          # /videos/sample.mp4
    
    # Volume mounts for video file access
    volumes:
      # Mount videos directory as read-only
      # Contains input video files for processing
      - ../../videos:/videos:ro
    
    # Dependency management - wait for Kafka to be ready
    depends_on:
      kafka:
        condition: service_healthy  # Ensures Kafka is operational
    
    # Network configuration
    networks:
      - ${NETWORK_NAME}  # video-rag-network bridge
    
    # Restart policy
    restart: unless-stopped
    
    # Note: No GPU allocation needed - CPU-based video processing
    # OpenCV handles video decoding and frame extraction efficiently

# Network reference - managed by infrastructure
networks:
  video-rag-network:
    name: ${NETWORK_NAME}
    external: true  # Network created by infrastructure services
