# ============================================================================
# OCR Service - Optical Character Recognition Microservice
# ============================================================================
#
# PURPOSE:
#   Extracts text content from video frames using EasyOCR deep learning models.
#   Processes frames in parallel with other vision services, contributing text
#   data to the comprehensive frame analysis pipeline.
#
# ROLE IN VIDEO RAG PIPELINE:
#   Input:  raw-frames topic (base64 encoded video frames)
#   Process: Text detection and recognition using EasyOCR
#   Output: ocr-results topic (extracted text with confidence scores)
#
# PROCESSING WORKFLOW:
#   1. Consume frame messages from Kafka 'raw-frames' topic
#   2. Decode base64 image data to OpenCV format
#   3. Apply EasyOCR text detection and recognition
#   4. Filter results by confidence threshold (>0.5)
#   5. Publish structured results to 'ocr-results' topic
#
# OCR CAPABILITIES:
#   - Multi-language support (English primary, configurable)
#   - Text detection in natural scenes and documents
#   - Confidence scoring for quality assessment
#   - Bounding box coordinates for spatial context
#   - Handles rotated and skewed text
#
# PERFORMANCE CHARACTERISTICS:
#   - GPU acceleration via NVIDIA CUDA
#   - Batch processing for efficiency
#   - ~50-100ms processing time per frame
#   - Memory usage: ~2-4GB GPU RAM
#   - Concurrent processing with other vision services
#
# OUTPUT FORMAT:
#   {
#     "frame_id": "uuid",
#     "service": "ocr-service",
#     "timestamp": 1234567890.456,
#     "results": {
#       "text": "detected text content",
#       "confidence": 0.95,
#       "word_count": 5,
#       "bounding_boxes": [...]
#     },
#     "processing_time_ms": 87.3
#   }
#
# DEPENDENCIES:
#   - Kafka cluster (healthy)
#   - NVIDIA GPU with CUDA support
#   - EasyOCR models (downloaded on first run)
#
# MONITORING:
#   - Health endpoint: http://localhost:8001/health
#   - Readiness check: http://localhost:8001/ready
#   - Kafka consumer lag via Kafka UI
#
# ============================================================================

services:
  ocr-service:
    # Build from local Dockerfile with EasyOCR dependencies
    build:
      context: . # Current service directory
      dockerfile: Dockerfile

    container_name: ${OCR_SERVICE_CONTAINER_NAME}
    hostname: ocr-service # Fixed hostname for service discovery
    
    # OrbStack will automatically create: ocr-service.video-rag.orb.local

    # Port mapping for health checks and debugging
    ports:
      # HTTP API for health checks and optional direct processing
      - "${OCR_SERVICE_HOST_PORT}:${OCR_SERVICE_INTERNAL_PORT}" # 8001:8000

    # Service configuration via environment variables
    environment:
      # Kafka connection configuration
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS} # kafka:9092

      # Topic configuration for message flow
      - KAFKA_INPUT_TOPIC=${KAFKA_TOPIC_RAW_FRAMES} # raw-frames
      - KAFKA_OUTPUT_TOPIC=${KAFKA_TOPIC_OCR_RESULTS} # ocr-results

      # Consumer group for load balancing and fault tolerance
      - KAFKA_CONSUMER_GROUP=${OCR_SERVICE_CONSUMER_GROUP} # ocr-service-group

      # Service identification
      - SERVICE_NAME=${OCR_SERVICE_NAME} # ocr-service

      # Logging configuration
      - LOG_LEVEL=${LOG_LEVEL} # INFO/DEBUG

    # Note: Kafka dependency managed by infrastructure startup order

    # Production resource management (CPU-only mode)
    deploy:
      resources:
        # Resource limits to prevent system overload
        limits:
          memory: 4G # Maximum memory for text processing
          cpus: '2.0' # Maximum CPU cores for text processing
        # Resource reservations for guaranteed performance
        reservations:
          memory: 2G # Guaranteed memory for processing
          cpus: '1.0' # Guaranteed CPU for consistent processing

    # Enterprise security configuration
    security_opt:
      # Prevent privilege escalation attacks
      - no-new-privileges:true
    
    # Production logging configuration
    logging:
      driver: "json-file"
      options:
        # Log rotation to prevent disk space issues
        max-size: "10m" # Maximum log file size
        max-file: "3" # Number of rotated log files to keep
        # Structured logging for centralized log aggregation
        labels: "service=ocr-service,environment=production,component=vision-processing"

    # Network configuration
    networks:
      - ${NETWORK_NAME} # video-rag-network bridge

    # Production restart policy
    restart: unless-stopped

    # Note: Volume mounts for models handled in Dockerfile
    # EasyOCR models downloaded to container on first run

# Network reference - managed by infrastructure
networks:
  video-rag-network:
    name: ${NETWORK_NAME}
    external: true # Network created by infrastructure services
