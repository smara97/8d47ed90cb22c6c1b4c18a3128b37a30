# ============================================================================
# Object Detection Service - YOLO-based Computer Vision Microservice
# ============================================================================
#
# PURPOSE:
#   Performs real-time object detection on video frames using YOLO models.
#   Identifies and localizes objects, people, vehicles, and other entities
#   within video content for comprehensive scene understanding.
#
# ROLE IN VIDEO RAG PIPELINE:
#   Input:  raw-frames topic (base64 encoded video frames)
#   Process: Object detection using YOLO11/YOLOv8 models
#   Output: detection-results topic (objects with bounding boxes and confidence)
#
# PROCESSING WORKFLOW:
#   1. Consume frame messages from Kafka 'raw-frames' topic
#   2. Decode base64 image data to tensor format
#   3. Run YOLO inference on GPU for object detection
#   4. Apply Non-Maximum Suppression (NMS) for duplicate removal
#   5. Filter detections by confidence threshold
#   6. Publish structured results to 'detection-results' topic
#
# DETECTION CAPABILITIES:
#   - 80+ COCO object classes (person, car, dog, etc.)
#   - Bounding box coordinates (x1, y1, x2, y2)
#   - Confidence scores for each detection
#   - Class probability distributions
#   - Multi-scale detection (small to large objects)
#
# MODEL SUPPORT:
#   - YOLO11n/s/m/l/x variants (nano to extra-large)
#   - YOLOv8 family compatibility
#   - Custom trained models (.pt format)
#   - Automatic model loading from volume mount
#
# PERFORMANCE CHARACTERISTICS:
#   - GPU acceleration via NVIDIA CUDA
#   - ~30-60ms inference time per frame (depends on model size)
#   - Memory usage: ~1-6GB GPU RAM (model dependent)
#   - Batch processing support for efficiency
#   - Real-time processing capability
#
# OUTPUT FORMAT:
#   {
#     "frame_id": "uuid",
#     "service": "detector-service",
#     "timestamp": 1234567890.789,
#     "results": {
#       "detections": [
#         {
#           "class_id": 0,
#           "class_name": "person",
#           "confidence": 0.95,
#           "bbox": [100, 200, 300, 400],
#           "width": 200,
#           "height": 200
#         }
#       ],
#       "detection_count": 1
#     },
#     "processing_time_ms": 45.2
#   }
#
# DEPENDENCIES:
#   - Kafka cluster (healthy)
#   - NVIDIA GPU with CUDA support
#   - YOLO model weights (mounted from host)
#   - Ultralytics YOLO library
#
# MONITORING:
#   - Health endpoint: http://localhost:8002/health
#   - Model loading status and GPU utilization
#   - Detection throughput and latency metrics
#
# ============================================================================

services:
  detector-service:
    # Build from local Dockerfile with YOLO dependencies
    build:
      context: . # Current service directory
      dockerfile: Dockerfile

    container_name: ${DETECTOR_SERVICE_CONTAINER_NAME}
    hostname: detector-service # Fixed hostname for service discovery
    
    # OrbStack will automatically create: detector-service.video-rag.orb.local

    # Port mapping for health checks and debugging
    ports:
      # HTTP API for health checks and optional direct inference
      - "${DETECTOR_SERVICE_HOST_PORT}:${DETECTOR_SERVICE_INTERNAL_PORT}" # 8002:8000

    # Service configuration via environment variables
    environment:
      # Kafka connection configuration
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS} # kafka:9092

      # Topic configuration for message flow
      - KAFKA_INPUT_TOPIC=${KAFKA_TOPIC_RAW_FRAMES} # raw-frames
      - KAFKA_OUTPUT_TOPIC=${KAFKA_TOPIC_DETECTION_RESULTS} # detection-results

      # Consumer group for load balancing
      - KAFKA_CONSUMER_GROUP=${DETECTOR_SERVICE_CONSUMER_GROUP} # detector-service-group

      # Service identification
      - SERVICE_NAME=${DETECTOR_SERVICE_NAME} # detector-service

      # Model configuration
      - MODEL_PATH=${DETECTOR_MODEL_PATH} # /app/models/yolo11n.pt

      # Logging configuration
      - LOG_LEVEL=${LOG_LEVEL} # INFO/DEBUG

    # Volume mounts for model access
    volumes:
      # Mount models directory as read-only
      # Contains YOLO weights and configuration files
      - ../../models:/app/models:ro

    # Note: Kafka dependency managed by infrastructure startup order

    # Network configuration
    networks:
      - ${NETWORK_NAME} # video-rag-network bridge

    # Restart policy
    restart: unless-stopped

    # Production resource management (CPU-only mode)
    deploy:
      resources:
        limits:
          memory: 6G # Maximum memory for object detection processing
          cpus: '2.0' # Maximum CPU cores for object detection
        reservations:
          memory: 3G # Guaranteed memory for processing
          cpus: '1.0' # Guaranteed CPU for consistent processing

    # Enterprise security configuration
    security_opt:
      - no-new-privileges:true
    
    # Production logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=detector-service,environment=production,component=vision-processing"

# Network reference - managed by infrastructure
networks:
  video-rag-network:
    name: ${NETWORK_NAME}
    external: true # Network created by infrastructure services
